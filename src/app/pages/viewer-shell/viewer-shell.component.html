<div
  class="viewer-shell"
  [style.--left-dock-width.px]="leftDockWidth()"
  [style.--right-dock-width.px]="rightDockWidth()"
  [style.--dock-collapsed-width.px]="dockCollapsedWidth"
>
  <header class="viewer-shell__command-bar">
    <div class="viewer-shell__command-row viewer-shell__command-row--primary">
      <div class="viewer-shell__command-section viewer-shell__command-section--left">
        <label class="viewer-shell__button viewer-shell__button--primary viewer-shell__file-picker">
          <input
            #importInput
            class="viewer-shell__file-picker-input"
            type="file"
            accept="application/pdf"
            multiple
            (change)="onFileChange($event)"
          />
          <span>PDFを追加</span>
        </label>
        <button type="button" class="viewer-shell__button viewer-shell__button--ghost" (click)="openLibraryDock()">
          ライブラリ
        </button>
        <div class="viewer-shell__command-group viewer-shell__command-group--tight">
          <button
            type="button"
            class="viewer-shell__button viewer-shell__button--ghost viewer-shell__button--compact"
            (click)="selectPrevPdf()"
            [disabled]="!library.hasPrev()"
            title="前のPDF (Ctrl/Cmd + [)"
          >
            前へ
          </button>
          <button
            type="button"
            class="viewer-shell__button viewer-shell__button--ghost viewer-shell__button--compact"
            (click)="selectNextPdf()"
            [disabled]="!library.hasNext()"
            title="次のPDF (Ctrl/Cmd + ])"
          >
            次へ
          </button>
        </div>
        @if (flags.search) {
          <button
            type="button"
            class="viewer-shell__button viewer-shell__button--ghost viewer-shell__command-search"
            (click)="openSearchPanel()"
            [disabled]="!hasPdf()"
          >
            検索
          </button>
        }
        <div class="viewer-shell__tools-menu" #toolsMenu>
          <button
            type="button"
            class="viewer-shell__button viewer-shell__button--ghost"
            (click)="toggleToolsMenu()"
            [attr.aria-expanded]="toolsMenuOpen()"
            aria-haspopup="menu"
          >
            …ツール
          </button>
          @if (toolsMenuOpen()) {
            <div class="viewer-shell__tools-menu-popover" role="menu">
              @if (flags.search) {
                <button
                  type="button"
                  class="viewer-shell__button viewer-shell__button--ghost viewer-shell__button--menu viewer-shell__tools-menu-item viewer-shell__tools-menu-item--responsive"
                  (click)="openSearchPanel(); closeToolsMenu()"
                  [disabled]="!hasPdf()"
                >
                  検索
                </button>
              }
              @if (flags.ocr) {
                <button
                  type="button"
                  class="viewer-shell__button viewer-shell__button--ghost viewer-shell__button--menu viewer-shell__tools-menu-item"
                  (click)="openOcrPanel(); closeToolsMenu()"
                  [disabled]="!hasPdf()"
                >
                  OCR
                </button>
              }
              @if (flags.compare) {
                <button
                  type="button"
                  class="viewer-shell__button viewer-shell__button--ghost viewer-shell__button--menu viewer-shell__tools-menu-item"
                  (click)="openComparePanel(); closeToolsMenu()"
                  [disabled]="!hasPdf()"
                >
                  比較
                </button>
              }
            </div>
          }
        </div>
      </div>

      <div class="viewer-shell__command-section viewer-shell__command-section--center">
        <div class="viewer-shell__doc-title">
          @if (library.selectedItem(); as selected) {
            <span class="viewer-shell__doc-name" [attr.title]="selected.name">{{ selected.displayName }}</span>
          } @else if (pdf.pdfName()) {
            <span class="viewer-shell__doc-name" [attr.title]="pdf.pdfName()">{{ pdf.pdfName() }}</span>
          } @else {
            <span class="viewer-shell__doc-name viewer-shell__doc-name--empty">ファイル未選択</span>
          }
        </div>
      </div>

      <div class="viewer-shell__command-section viewer-shell__command-section--status">
        <div class="viewer-shell__status-slot" role="status" aria-live="polite">
          <div class="viewer-shell__status-group">
            @for (item of visibleStatusItems(); track $index) {
              <span
                class="viewer-shell__status-pill"
                [class.viewer-shell__status-pill--error]="item.variant === 'error'"
                [class.viewer-shell__status-pill--loading]="item.variant === 'loading'"
                [class.viewer-shell__status-pill--info]="item.variant === 'info'"
                [attr.title]="item.title ?? item.label"
              >
                {{ item.label }}
              </span>
            }
            @if (statusOverflowCount() > 0) {
              <span class="viewer-shell__status-pill viewer-shell__status-pill--muted">
                +{{ statusOverflowCount() }}
              </span>
            }
          </div>
        </div>
      </div>

      <div class="viewer-shell__command-section viewer-shell__command-section--right">
        <div class="viewer-shell__command-group viewer-shell__command-group--tight">
          <button
            type="button"
            class="viewer-shell__button viewer-shell__button--ghost"
            (click)="zoomOut()"
            [disabled]="!hasPdf()"
          >
            -
          </button>
          <span class="viewer-shell__zoom-indicator">{{ zoomPercent() }}%</span>
          <button
            type="button"
            class="viewer-shell__button viewer-shell__button--ghost"
            (click)="zoomIn()"
            [disabled]="!hasPdf()"
          >
            +
          </button>
          <button
            type="button"
            class="viewer-shell__button viewer-shell__button--ghost viewer-shell__zoom-reset"
            (click)="resetZoom()"
            [disabled]="!hasPdf()"
          >
            等倍
          </button>
        </div>

        <div class="viewer-shell__command-group">
          <button
            type="button"
            class="viewer-shell__button viewer-shell__button--ghost"
            [class.viewer-shell__button--active]="showObjects()"
            (click)="toggleObjects()"
            [disabled]="!hasPdf() || (!flags.markers && !flags.comments)"
          >
            Objects {{ showObjects() ? 'ON' : 'OFF' }}
          </button>
          <button
            type="button"
            class="viewer-shell__button"
            (click)="downloadPdf()"
            [disabled]="!hasPdf() || isDownloading()"
          >
            ダウンロード
          </button>
        </div>
      </div>
    </div>

    <div class="viewer-shell__command-row viewer-shell__command-row--nav">
      <div class="viewer-shell__command-section viewer-shell__command-section--nav-left">
        <div class="viewer-shell__page-jump">
          <span class="viewer-shell__page-prefix">p</span>
          <input
            #pageInputField
            class="viewer-shell__page-input"
            type="text"
            inputmode="numeric"
            pattern="[0-9]*"
            [disabled]="!hasPdf()"
            [ngModel]="pageInputValue()"
            (ngModelChange)="onPageInputChange($event)"
            (keydown.enter)="$event.preventDefault(); commitPageInput()"
            (blur)="commitPageInput()"
            aria-label="ページ番号"
          />
          <span class="viewer-shell__page-total">/ {{ pageCountLabel() }}</span>
        </div>
      </div>
      <div class="viewer-shell__command-section viewer-shell__command-section--nav-center">
        <input
          class="viewer-shell__page-slider"
          type="range"
          min="1"
          step="0.01"
          [max]="pdf.pageCount() || 1"
          [value]="pageSliderValue()"
          [disabled]="!hasPdf()"
          (pointerdown)="onPageSliderPointerDown()"
          (pointerup)="onPageSliderPointerUp()"
          (pointercancel)="onPageSliderPointerUp()"
          (input)="onPageSliderInput($event)"
          (change)="onPageSliderChange($event)"
          aria-label="ページスライダー"
        />
      </div>
      <div class="viewer-shell__command-section viewer-shell__command-section--nav-right"></div>
    </div>
  </header>

  <div class="viewer-shell__layout">
    <aside
      class="viewer-shell__dock viewer-shell__dock--left"
      [class.viewer-shell__dock--collapsed]="!leftDockOpen()"
      [class.viewer-shell__dock--expanded]="leftDockOpen()"
    >
      <div class="viewer-shell__dock-header">
        <div class="viewer-shell__dock-tabs" role="tablist" aria-label="左ドック">
          <button
            type="button"
            class="viewer-shell__dock-tab"
            [class.viewer-shell__dock-tab--active]="leftDockTab() === 'library'"
            (click)="setLeftDockTab('library')"
            [attr.aria-pressed]="leftDockTab() === 'library'"
            aria-label="Library"
          >
            <span class="viewer-shell__dock-tab-label">Library</span>
            <span class="viewer-shell__dock-tab-short" aria-hidden="true">L</span>
          </button>
          <button
            type="button"
            class="viewer-shell__dock-tab"
            [class.viewer-shell__dock-tab--active]="leftDockTab() === 'thumbnails'"
            (click)="setLeftDockTab('thumbnails')"
            [attr.aria-pressed]="leftDockTab() === 'thumbnails'"
            aria-label="Thumbnails"
          >
            <span class="viewer-shell__dock-tab-label">Thumbnails</span>
            <span class="viewer-shell__dock-tab-short" aria-hidden="true">T</span>
          </button>
        </div>
        <button
          type="button"
          class="viewer-shell__icon-button"
          (click)="toggleLeftDock()"
          [attr.aria-label]="leftDockOpen() ? '左ドックを閉じる' : '左ドックを開く'"
        >
          {{ leftDockOpen() ? '<<' : '>>' }}
        </button>
      </div>
      <div class="viewer-shell__dock-body">
        @if (leftDockTab() === 'library') {
          <section class="viewer-shell__panel">
            <div class="viewer-shell__panel-header">
              <h3 class="viewer-shell__panel-title">ライブラリ</h3>
              <span class="viewer-shell__badge">{{ library.items().length }}件</span>
            </div>
            <div class="viewer-shell__panel-body">
              @if (!library.items().length) {
                <div class="viewer-shell__empty-state viewer-shell__empty-state--dock">
                  PDFを追加して開始してください。
                </div>
              } @else {
                <div class="viewer-shell__library-list">
                  @for (item of library.items(); track item.id) {
                    <button
                      type="button"
                      class="viewer-shell__library-item"
                      [class.viewer-shell__library-item--selected]="item.id === library.selectedId()"
                      [attr.aria-pressed]="item.id === library.selectedId()"
                      (click)="selectLibraryItem(item.id)"
                    >
                      <div class="viewer-shell__library-thumb">
                        @if (item.thumbnailUrl === undefined) {
                          <div class="viewer-shell__library-thumb-skeleton" aria-hidden="true"></div>
                        } @else if (item.thumbnailUrl) {
                          <img [src]="item.thumbnailUrl" [alt]="item.displayName" />
                        } @else {
                          <div class="viewer-shell__library-thumb-placeholder" aria-hidden="true">
                            <span>PDF</span>
                          </div>
                        }
                      </div>
                      <div class="viewer-shell__library-meta">
                        <span class="viewer-shell__library-name" [attr.title]="item.name">
                          {{ item.displayName }}
                        </span>
                        @if (item.pageCount) {
                          <span class="viewer-shell__library-pages">{{ item.pageCount }}ページ</span>
                        } @else {
                          <span class="viewer-shell__library-pages">ページ数取得中</span>
                        }
                      </div>
                    </button>
                  }
                </div>
              }
            </div>
          </section>
        }
        @if (leftDockTab() === 'thumbnails') {
          <section class="viewer-shell__panel">
            <div class="viewer-shell__panel-header">
              <h3 class="viewer-shell__panel-title">ページサムネイル</h3>
              <span class="viewer-shell__badge">{{ pageCountLabel() }}</span>
            </div>
            <div class="viewer-shell__panel-body">
              @if (!hasPdf()) {
                <div class="viewer-shell__empty-state viewer-shell__empty-state--dock">
                  PDFを読み込むとサムネイルが表示されます。
                </div>
              } @else {
                <div class="viewer-shell__thumbnail-list">
                  @for (page of pageNumbers(); track page) {
                    <button
                      type="button"
                      class="viewer-shell__thumbnail-item"
                      [class.viewer-shell__thumbnail-item--selected]="currentPage() === page"
                      (click)="jumpToPage(page)"
                      [attr.aria-pressed]="currentPage() === page"
                    >
                      <div class="viewer-shell__thumbnail-frame">
                        <canvas
                          class="viewer-shell__thumbnail-canvas"
                          #thumbnailCanvas
                          [attr.data-page-number]="page"
                        ></canvas>
                      </div>
                      <span class="viewer-shell__thumbnail-label">p{{ page }}</span>
                    </button>
                  }
                </div>
              }
            </div>
          </section>
        }
      </div>
      <div
        class="viewer-shell__dock-resizer"
        (pointerdown)="startDockResize('left', $event)"
        aria-label="左ドックの幅を調整"
      ></div>
    </aside>

    <section class="viewer-shell__viewer" #viewerSection (click)="closeContextMenu()">
      @if (!hasPdf()) {
        <div class="viewer-shell__viewer-hint">
          <p>右クリックのコンテキストメニューからコメント追加とテキストハイライトを行えます。</p>
          <p>検索結果は自動でハイライト表示されます。</p>
        </div>
      }

      @if (isDragOver()) {
        <div class="viewer-shell__drag-overlay" aria-hidden="true">
          <div class="viewer-shell__drag-overlay-content">PDFをここにドロップ</div>
        </div>
      }

      @if (!hasPdf()) {
        <div class="viewer-shell__empty-state">
          <p>PDF を読み込むとここに表示されます。</p>
        </div>
      }

      @if (isBrowser && hasPdf()) {
        <div
          class="viewer-shell__viewer-grid"
          #viewerGrid
          [class.viewer-shell__viewer-grid--compare]="flags.compare && compare.compareTargetSource()"
        >
          <div class="viewer-shell__viewer-pane">
            @if (flags.compare && compare.compareTargetSource()) {
              <div class="viewer-shell__viewer-pane-label">現在表示中</div>
            }
            <div class="viewer-shell__pages" #pagesHost (contextmenu)="openContextMenuFromViewer($event)">
              <div class="viewer-shell__pdf-viewer-host" #pdfViewerHost>
                <div class="viewer-shell__pdf-pages">
                  @for (page of pdf.renderedPages(); track page.pageNumber) {
                    <div class="viewer-shell__pdf-page page" [attr.data-page-number]="page.pageNumber">
                      <canvas
                        class="viewer-shell__pdf-canvas"
                        #pageCanvas
                        [attr.data-page-number]="page.pageNumber"
                      ></canvas>
                      <div
                        class="viewer-shell__text-layer textLayer"
                        #pageTextLayer
                        [attr.data-page-number]="page.pageNumber"
                      ></div>
                    </div>
                  }
                </div>
              </div>
              <div class="viewer-shell__page-overlays">
                @for (overlay of pageOverlays(); track trackPageOverlay($index, overlay)) {
                  <div
                    class="viewer-shell__page-overlay"
                    [class.viewer-shell__page-overlay--changed]="isChangedPage(overlay.pageNumber)"
                    [attr.id]="pageAnchorId(overlay.pageNumber)"
                    [attr.data-page]="overlay.pageNumber"
                    [style.--overlay-left]="overlay.left + 'px'"
                    [style.--overlay-top]="overlay.top + 'px'"
                    [style.--overlay-width]="overlay.width + 'px'"
                    [style.--overlay-height]="overlay.height + 'px'"
                  >
                    @if (flags.compare && compare.compareTargetSource()) {
                      @for (rect of diffRectsFor(overlay.pageNumber); track $index) {
                        <div
                          class="viewer-shell__diff-highlight"
                          [style.--diff-left]="rect.left + '%'"
                          [style.--diff-top]="rect.top + '%'"
                          [style.--diff-width]="rect.width + '%'"
                          [style.--diff-height]="rect.height + '%'"
                        ></div>
                      }
                    }

                    @if (showObjects() && (flags.markers || flags.comments)) {
                      @if (flags.markers) {
                        @for (marker of markersFor(overlay.pageNumber); track trackMarker($index, marker)) {
                          @for (rect of marker.rects; track $index) {
                            <div
                              class="viewer-shell__page-highlight"
                              [style.--marker-left]="rect.left + '%'"
                              [style.--marker-top]="rect.top + '%'"
                              [style.--marker-width]="rect.width + '%'"
                              [style.--marker-height]="rect.height + '%'"
                              [style.--marker-color]="marker.color"
                              [style.--highlight-strong]="highlightStrongColor(marker.color)"
                              [class.viewer-shell__page-highlight--selected]="isSelectedMarker(marker.id)"
                              [attr.data-marker-id]="marker.id"
                              (click)="focusMarker(marker, $event)"
                            ></div>
                          }
                          @if (marker.label && marker.rects.length) {
                            <div
                              class="viewer-shell__page-highlight-label"
                              [style.--label-left]="marker.rects[0].left + '%'"
                              [style.--label-top]="marker.rects[0].top + '%'"
                              [style.--label-color]="marker.color"
                              [style.--highlight-strong]="highlightStrongColor(marker.color)"
                              [class.viewer-shell__page-highlight-label--selected]="isSelectedMarker(marker.id)"
                              [attr.data-marker-id]="marker.id"
                              (click)="focusMarker(marker, $event)"
                            >
                              {{ marker.label }}
                            </div>
                          }
                        }
                      }

                      @if (flags.comments) {
                        @for (comment of commentsFor(overlay.pageNumber); track trackComment($index, comment)) {
                          @if (calloutLayout(comment); as callout) {
                            <div
                              class="viewer-shell__comment-callout"
                              [class.viewer-shell__comment-callout--selected]="isSelectedComment(comment.id)"
                              [style.--line-length]="callout.lineLength + 'px'"
                              [style.--line-angle]="callout.lineAngle + 'deg'"
                              [style.--bubble-width]="
                                (comment.bubbleWidth ?? commentLayoutSettings().bubbleWidth) + 'px'
                              "
                              [style.--bubble-height]="
                                ((comment.bubbleHeight ?? commentLayoutSettings().bubbleHeight) ||
                                  commentLayoutSettings().bubbleHeight) + 'px'
                              "
                            >
                              <span
                                class="viewer-shell__comment-anchor"
                                [style.--anchor-left]="comment.anchorX * 100 + '%'"
                                [style.--anchor-top]="comment.anchorY * 100 + '%'"
                                (click)="focusComment(comment, $event)"
                                (pointerdown)="startCommentAnchorDrag(comment, $event)"
                                aria-label="コメントのアンカーを移動"
                              ></span>
                              <span
                                class="viewer-shell__comment-line"
                                [style.--line-left]="comment.anchorX * 100 + '%'"
                                [style.--line-top]="comment.anchorY * 100 + '%'"
                              ></span>
                              <div
                                class="viewer-shell__comment-bubble"
                                [attr.data-comment-id]="comment.id"
                                [style.--bubble-left]="comment.bubbleX * 100 + '%'"
                                [style.--bubble-top]="comment.bubbleY * 100 + '%'"
                                (click)="focusComment(comment, $event)"
                              >
                                <div
                                  class="viewer-shell__comment-bubble-header"
                                  (pointerdown)="startCommentBubbleDrag(comment, $event)"
                                >
                                  @if (isEditingTitle(comment.id)) {
                                    <input
                                      type="text"
                                      class="viewer-shell__comment-title-input"
                                      [ngModel]="titleDraft(comment.id)"
                                      (ngModelChange)="setTitleDraft(comment.id, $event)"
                                      (keyup.enter)="saveTitleEdit(comment.id)"
                                      (keydown.escape)="cancelTitleEdit(comment.id)"
                                      (blur)="saveTitleEdit(comment.id)"
                                      (pointerdown)="$event.stopPropagation()"
                                      aria-label="コメントタイトル"
                                      placeholder="コメントタイトル"
                                      autofocus
                                    />
                                  } @else {
                                    <span class="viewer-shell__comment-bubble-title">
                                      {{ commentTitle(comment) }}
                                    </span>
                                  }
                                  <span class="viewer-shell__comment-bubble-meta">p{{ comment.page }}</span>
                                  @if (!isReadOnlyComment(comment)) {
                                    <button
                                      type="button"
                                      class="viewer-shell__comment-bubble-edit"
                                      (click)="startTitleEdit(comment, $event)"
                                      (pointerdown)="$event.stopPropagation()"
                                      aria-label="タイトルを編集"
                                    >
                                      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                        <path
                                          d="M4 17.25V20h2.75L17.81 8.94l-2.75-2.75L4 17.25zm15.71-9.04a1 1 0 0 0 0-1.41l-2.51-2.5a1 1 0 0 0-1.41 0l-1.7 1.7 3.92 3.92 1.7-1.71z"
                                        />
                                      </svg>
                                    </button>
                                  }
                                </div>
                                <div
                                  class="viewer-shell__comment-bubble-body"
                                  #commentBody
                                  [attr.data-comment-id]="comment.id"
                                >
                                  <div class="viewer-shell__comment-bubble-thread">
                                    @for (message of comment.messages; track message.id) {
                                      <div class="viewer-shell__comment-bubble-message">
                                        <p>{{ message.text }}</p>
                                        <span class="viewer-shell__comment-bubble-timestamp">
                                          {{ message.createdAt | date: 'MM/dd HH:mm' }}
                                        </span>
                                      </div>
                                    } @empty {
                                      <p class="viewer-shell__comment-bubble-empty">コメントはまだありません。</p>
                                    }
                                  </div>
                                </div>
                                @if (isSelectedComment(comment.id) && !isReadOnlyComment(comment)) {
                                  <div class="viewer-shell__comment-bubble-actions">
                                    <textarea
                                      #replyTextarea
                                      rows="2"
                                      class="viewer-shell__textarea"
                                      [attr.data-comment-id]="comment.id"
                                      [placeholder]="comment.messages.length ? '返信を記入' : 'コメントを追加'"
                                      [ngModel]="replyDraft(comment.id)"
                                      (ngModelChange)="setReplyDraft(comment.id, $event)"
                                      (keydown)="onReplyKeydown(comment.id, $event)"
                                      (pointerdown)="$event.stopPropagation()"
                                    ></textarea>
                                    <div class="viewer-shell__comment-bubble-actions-row">
                                      <span class="viewer-shell__helper-text">コメントを会話として残せます。</span>
                                      <button
                                        type="button"
                                        class="viewer-shell__button"
                                        (click)="addReply(comment.id)"
                                        [disabled]="!hasReplyDraft(comment.id)"
                                        (pointerdown)="$event.stopPropagation()"
                                      >
                                        返信
                                      </button>
                                    </div>
                                  </div>
                                }
                                @if (!isReadOnlyComment(comment)) {
                                  <div
                                    class="viewer-shell__bubble-handle viewer-shell__bubble-handle--width"
                                    (pointerdown)="startCommentResize(comment, 'bubbleWidth', $event)"
                                  ></div>
                                  <div
                                    class="viewer-shell__bubble-handle viewer-shell__bubble-handle--height"
                                    (pointerdown)="startCommentResize(comment, 'bubbleHeight', $event)"
                                  ></div>
                                  <div
                                    class="viewer-shell__bubble-handle viewer-shell__bubble-handle--corner"
                                    (pointerdown)="startCommentResize(comment, 'bubbleBoth', $event)"
                                  ></div>
                                }
                              </div>
                            </div>
                          }
                        }
                      }
                    }
                  </div>
                }
              </div>
            </div>
          </div>
          @if (flags.compare && compare.compareTargetSource()) {
            <div class="viewer-shell__viewer-pane">
              <div class="viewer-shell__viewer-pane-label">比較対象</div>
              @if (!compare.compareTargetPages().length) {
                <div class="viewer-shell__empty-state">
                  <p>比較対象 PDF を読み込み中...</p>
                </div>
              }
              <div class="viewer-shell__pages" #comparePagesHost>
                <div class="viewer-shell__pdf-viewer-host" #comparePdfViewerHost>
                  <div class="viewer-shell__pdf-pages">
                    @for (page of compare.compareTargetPages(); track page.pageNumber) {
                      <div class="viewer-shell__pdf-page page" [attr.data-page-number]="page.pageNumber">
                        <canvas
                          class="viewer-shell__pdf-canvas"
                          #comparePageCanvas
                          [attr.data-page-number]="page.pageNumber"
                        ></canvas>
                        <div
                          class="viewer-shell__text-layer textLayer"
                          #comparePageTextLayer
                          [attr.data-page-number]="page.pageNumber"
                        ></div>
                      </div>
                    }
                  </div>
                </div>
                <div class="viewer-shell__page-overlays">
                  @for (overlay of comparePageOverlays(); track trackPageOverlay($index, overlay)) {
                    <div
                      class="viewer-shell__page-overlay"
                      [class.viewer-shell__page-overlay--changed]="isChangedPage(overlay.pageNumber)"
                      [attr.id]="comparePageAnchorId(overlay.pageNumber)"
                      [attr.data-compare-page]="overlay.pageNumber"
                      [style.--overlay-left]="overlay.left + 'px'"
                      [style.--overlay-top]="overlay.top + 'px'"
                      [style.--overlay-width]="overlay.width + 'px'"
                      [style.--overlay-height]="overlay.height + 'px'"
                    >
                      @for (rect of compareDiffRectsFor(overlay.pageNumber); track $index) {
                        <div
                          class="viewer-shell__diff-highlight"
                          [style.--diff-left]="rect.left + '%'"
                          [style.--diff-top]="rect.top + '%'"
                          [style.--diff-width]="rect.width + '%'"
                          [style.--diff-height]="rect.height + '%'"
                        ></div>
                      }
                      <div class="viewer-shell__page-label">Page {{ overlay.pageNumber }}</div>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      }

      @if (contextMenu().visible) {
        <div
          class="viewer-shell__context-menu"
          [style.--context-menu-left]="contextMenu().x + 'px'"
          [style.--context-menu-top]="contextMenu().y + 'px'"
          (click)="$event.stopPropagation()"
        >
          @if (flags.comments) {
            <button
              type="button"
              class="viewer-shell__button viewer-shell__button--menu"
              (click)="addCommentFromContextMenu()"
            >
              コメントを追加
            </button>
          }
          @if (flags.markers) {
            <button
              type="button"
              class="viewer-shell__button viewer-shell__button--menu"
              (click)="addHighlightFromSelection()"
              [disabled]="!contextMenu().canHighlight"
            >
              選択範囲をハイライト
            </button>
            <div class="viewer-shell__highlight-swatches">
              @for (swatch of highlightSwatches; track swatch.id) {
                <button
                  type="button"
                  class="viewer-shell__highlight-swatch"
                  [class.viewer-shell__highlight-swatch--selected]="
                    swatch.color === selectedHighlightColor()
                  "
                  [style.--swatch-color]="swatch.color"
                  (click)="selectHighlightColor(swatch.color)"
                  [attr.aria-label]="swatch.label"
                  [attr.aria-pressed]="swatch.color === selectedHighlightColor()"
                ></button>
              }
            </div>
            @if (contextMenu().selectionText) {
              <p class="viewer-shell__helper-text viewer-shell__selection-preview">
                {{ contextMenu().selectionText }}
              </p>
            }
          }
        </div>
      }
    </section>

    <aside
      class="viewer-shell__dock viewer-shell__dock--right"
      [class.viewer-shell__dock--collapsed]="!rightDockOpen()"
      [class.viewer-shell__dock--expanded]="rightDockOpen()"
    >
      <div class="viewer-shell__dock-header">
        <div class="viewer-shell__dock-tabs" role="tablist" aria-label="右ドック">
          <button
            type="button"
            class="viewer-shell__dock-tab"
            [class.viewer-shell__dock-tab--active]="rightDockTab() === 'inspector'"
            (click)="setRightDockTab('inspector')"
            [attr.aria-pressed]="rightDockTab() === 'inspector'"
            aria-label="Inspector"
          >
            <span class="viewer-shell__dock-tab-label">Inspector</span>
            <span class="viewer-shell__dock-tab-short" aria-hidden="true">I</span>
          </button>
          <button
            type="button"
            class="viewer-shell__dock-tab"
            [class.viewer-shell__dock-tab--active]="rightDockTab() === 'lists'"
            (click)="setRightDockTab('lists')"
            [attr.aria-pressed]="rightDockTab() === 'lists'"
            aria-label="Lists"
          >
            <span class="viewer-shell__dock-tab-label">Lists</span>
            <span class="viewer-shell__dock-tab-short" aria-hidden="true">L</span>
          </button>
          @if (flags.compare) {
            <button
              type="button"
              class="viewer-shell__dock-tab"
              [class.viewer-shell__dock-tab--active]="rightDockTab() === 'compare'"
              (click)="setRightDockTab('compare')"
              [attr.aria-pressed]="rightDockTab() === 'compare'"
              aria-label="Compare"
            >
              <span class="viewer-shell__dock-tab-label">Compare</span>
              <span class="viewer-shell__dock-tab-short" aria-hidden="true">C</span>
            </button>
          }
        </div>
        <button
          type="button"
          class="viewer-shell__icon-button"
          (click)="toggleRightDock()"
          [attr.aria-label]="rightDockOpen() ? '右ドックを閉じる' : '右ドックを開く'"
        >
          {{ rightDockOpen() ? '>>' : '<<' }}
        </button>
      </div>
      <div class="viewer-shell__dock-body">
        @if (rightDockTab() === 'inspector') {
          <section class="viewer-shell__panel viewer-shell__panel--inspector">
            <div class="viewer-shell__panel-header">
              <h3 class="viewer-shell__panel-title">Inspector</h3>
            </div>
            <div class="viewer-shell__panel-body">
              @if (selectedMarker(); as marker) {
                <div class="viewer-shell__inspector-block">
                  <div class="viewer-shell__inspector-header">
                    <span class="viewer-shell__inspector-type">Highlight</span>
                    <span class="viewer-shell__inspector-meta">p{{ marker.page }}</span>
                  </div>
                  <label class="viewer-shell__field">
                    <span class="viewer-shell__field-label">ラベル</span>
                    <input
                      type="text"
                      class="viewer-shell__input"
                      [ngModel]="marker.label"
                      (ngModelChange)="updateMarker(marker.id, $event, marker.color)"
                      [disabled]="!canEditMarker(marker)"
                      placeholder="ハイライト"
                    />
                  </label>
                  <div class="viewer-shell__field">
                    <span class="viewer-shell__field-label">カラー</span>
                    <div class="viewer-shell__swatch-row">
                      @for (swatch of highlightSwatches; track swatch.id) {
                        <button
                          type="button"
                          class="viewer-shell__highlight-swatch"
                          [class.viewer-shell__highlight-swatch--selected]="swatch.color === marker.color"
                          [style.--swatch-color]="swatch.color"
                          (click)="updateMarker(marker.id, marker.label, swatch.color)"
                          [disabled]="!canEditMarker(marker)"
                          [attr.aria-label]="swatch.label"
                        ></button>
                      }
                    </div>
                  </div>
                  @if (marker.text) {
                    <p class="viewer-shell__helper-text viewer-shell__inspector-preview">
                      {{ marker.text }}
                    </p>
                  }
                  <div class="viewer-shell__inspector-actions">
                    <button
                      type="button"
                      class="viewer-shell__button viewer-shell__button--ghost viewer-shell__button--danger"
                      (click)="removeMarker(marker.id)"
                      [disabled]="!canEditMarker(marker)"
                    >
                      削除
                    </button>
                  </div>
                </div>
              } @else if (selectedComment(); as comment) {
                <div class="viewer-shell__inspector-block">
                  <div class="viewer-shell__inspector-header">
                    <span class="viewer-shell__inspector-type">Comment</span>
                    <span class="viewer-shell__inspector-meta">p{{ comment.page }}</span>
                  </div>
                  <div class="viewer-shell__field">
                    <span class="viewer-shell__field-label">タイトル</span>
                    @if (isEditingTitle(comment.id)) {
                      <input
                        type="text"
                        class="viewer-shell__input"
                        [ngModel]="titleDraft(comment.id)"
                        (ngModelChange)="setTitleDraft(comment.id, $event)"
                        (keyup.enter)="saveTitleEdit(comment.id)"
                        (keydown.escape)="cancelTitleEdit(comment.id)"
                        (blur)="saveTitleEdit(comment.id)"
                        placeholder="コメントタイトル"
                      />
                    } @else {
                      <div class="viewer-shell__field-inline">
                        <span class="viewer-shell__field-value">{{ commentTitle(comment) }}</span>
                        @if (canEditComment(comment)) {
                          <button
                            type="button"
                            class="viewer-shell__button viewer-shell__button--ghost viewer-shell__button--compact"
                            (click)="startTitleEdit(comment, $event)"
                          >
                            編集
                          </button>
                        }
                      </div>
                    }
                  </div>
                  <div class="viewer-shell__inspector-meta-row">
                    <span>{{ comment.messages.length }}件</span>
                    <span>{{ comment.createdAt | date: 'MM/dd HH:mm' }}</span>
                  </div>
                  @if (latestMessage(comment); as latest) {
                    <p class="viewer-shell__helper-text viewer-shell__inspector-preview">
                      {{ latest.text }}
                    </p>
                  } @else {
                    <p class="viewer-shell__helper-text">まだコメントはありません。</p>
                  }
                  <div class="viewer-shell__inspector-actions">
                    <button
                      type="button"
                      class="viewer-shell__button viewer-shell__button--ghost viewer-shell__button--danger"
                      (click)="removeComment(comment.id)"
                      [disabled]="!canEditComment(comment)"
                    >
                      削除
                    </button>
                  </div>
                </div>
              } @else {
                <div class="viewer-shell__empty-state viewer-shell__empty-state--panel">
                  <p>テキスト選択 → 右クリックでハイライト。</p>
                  <p>コメントは右クリックで追加できます。</p>
                </div>
              }
            </div>
          </section>
        }

        @if (rightDockTab() === 'lists') {
          @if (flags.search) {
            <section class="viewer-shell__panel">
              <div class="viewer-shell__panel-header">
                <h3 class="viewer-shell__panel-title">全文検索</h3>
                <button
                  type="button"
                  class="viewer-shell__button viewer-shell__button--ghost"
                  (click)="clearSearch()"
                >
                  クリア
                </button>
              </div>
              <div class="viewer-shell__panel-body">
                <div class="viewer-shell__form-row">
                  <input
                    #searchInput
                    class="viewer-shell__input viewer-shell__input--grow"
                    type="search"
                    placeholder="キーワード"
                    [ngModel]="searchQuery()"
                    (ngModelChange)="searchQuery.set($event)"
                    (keydown.enter)="performSearch()"
                  />
                  <button
                    type="button"
                    class="viewer-shell__button"
                    (click)="performSearch()"
                    [disabled]="search.isSearching()"
                  >
                    検索
                  </button>
                </div>
                @if (search.isSearching()) {
                  <div class="viewer-shell__helper-text">検索中...</div>
                }
                @if (search.searchResults().length) {
                  <div class="viewer-shell__search-list">
                    @for (section of searchSections(); track section.page) {
                      <div class="viewer-shell__search-section">
                        <div class="viewer-shell__search-section-header">
                          <span class="viewer-shell__search-section-label">p{{ section.page }}</span>
                          <span class="viewer-shell__search-section-count">{{ section.hits.length }}</span>
                        </div>
                        <div class="viewer-shell__search-items">
                          @for (hit of section.hits; track hit.id) {
                            <a
                              class="viewer-shell__search-item"
                              [href]="'#' + pageAnchorId(hit.page)"
                              (click)="focusSearchHit(hit, $event)"
                              [attr.title]="hit.context"
                            >
                              <span class="viewer-shell__search-item-context">{{ hit.context }}</span>
                            </a>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            </section>
          }

          @if (flags.markers) {
            <section class="viewer-shell__panel">
              <div class="viewer-shell__panel-header">
                <h3 class="viewer-shell__panel-title">ハイライト</h3>
                <span class="viewer-shell__badge">{{ highlightCount() }}</span>
              </div>
              <div class="viewer-shell__panel-body">
                <div class="viewer-shell__helper-text">
                  ページ上で右クリックし「選択範囲をハイライト」を選択してください。
                </div>
                <div class="viewer-shell__highlight-list">
                  @for (section of highlightSections(); track trackHighlightSection($index, section)) {
                    <div class="viewer-shell__highlight-section">
                      <div class="viewer-shell__highlight-section-header">
                        <span class="viewer-shell__highlight-section-label">p{{ section.page }}</span>
                        <span class="viewer-shell__highlight-section-count">{{ section.highlights.length }}</span>
                      </div>
                      <div class="viewer-shell__highlight-items">
                        @for (highlight of section.highlights; track trackHighlightItem($index, highlight)) {
                          <div
                            class="viewer-shell__highlight-item"
                            [class.viewer-shell__highlight-item--selected]="isSelectedMarker(highlight.id)"
                            (click)="focusMarker(highlight, $event)"
                            (keydown.enter)="focusMarker(highlight, $event)"
                            tabindex="0"
                          >
                            <span
                              class="viewer-shell__highlight-item-swatch"
                              [style.--swatch-color]="highlight.color"
                            ></span>
                            <span
                              class="viewer-shell__highlight-item-title"
                              [attr.title]="highlightLabel(highlight)"
                            >
                              {{ highlightLabel(highlight) }}
                            </span>
                            @if (!isReadOnlyMarker(highlight)) {
                              <button
                                class="viewer-shell__button viewer-shell__button--ghost viewer-shell__button--danger viewer-shell__button--compact viewer-shell__highlight-item-delete"
                                type="button"
                                (click)="removeHighlight(highlight.id); $event.stopPropagation()"
                              >
                                削除
                              </button>
                            }
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            </section>
          }

          @if (flags.comments) {
            <section class="viewer-shell__panel">
              <div class="viewer-shell__panel-header">
                <h3 class="viewer-shell__panel-title">コメント一覧</h3>
                <span class="viewer-shell__badge">{{ annotations.commentCount() }}</span>
              </div>
              <div class="viewer-shell__panel-body">
                <div class="viewer-shell__helper-text">
                  ページ上で右クリックし「コメントを追加」を選択してください。
                </div>
                <div class="viewer-shell__comment-list">
                  @for (section of commentSections(); track trackCommentSection($index, section)) {
                    <div class="viewer-shell__comment-section">
                      <div class="viewer-shell__comment-section-header">
                        <span class="viewer-shell__comment-section-label">p{{ section.page }}</span>
                        <span class="viewer-shell__comment-section-count">{{ section.comments.length }}</span>
                      </div>
                      <div class="viewer-shell__comment-items">
                        @for (comment of section.comments; track trackComment($index, comment)) {
                          <div
                            class="viewer-shell__comment-item"
                            [class.viewer-shell__comment-item--selected]="isSelectedComment(comment.id)"
                            (click)="focusComment(comment, $event)"
                            (keydown.enter)="focusComment(comment, $event)"
                            tabindex="0"
                          >
                            @if (!isReadOnlyComment(comment)) {
                              <button
                                class="viewer-shell__button viewer-shell__button--ghost viewer-shell__button--danger viewer-shell__button--compact viewer-shell__comment-item-delete"
                                type="button"
                                (click)="removeComment(comment.id); $event.stopPropagation()"
                              >
                                削除
                              </button>
                            }
                            <span class="viewer-shell__comment-item-title" [attr.title]="commentTitle(comment)">
                              {{ commentTitle(comment) }}
                            </span>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            </section>
          }

          @if (flags.ocr) {
            <section class="viewer-shell__panel">
              <div class="viewer-shell__panel-header">
                <h3 class="viewer-shell__panel-title">OCR とテキスト抽出</h3>
              </div>
              <div class="viewer-shell__panel-body">
                <div class="viewer-shell__card viewer-shell__ocr-setup">
                  <div class="viewer-shell__ocr-controls">
                    <div class="viewer-shell__ocr-field">
                      <label class="viewer-shell__ocr-label" for="ocr-scope">対象</label>
                      <select
                        id="ocr-scope"
                        class="viewer-shell__select"
                        [ngModel]="ocrScope()"
                        (ngModelChange)="ocrScope.set($event)"
                      >
                        <option value="page">ページ</option>
                        <option value="all">全ページ</option>
                      </select>
                    </div>
                    @if (ocrScope() === 'page') {
                      <div class="viewer-shell__ocr-field viewer-shell__ocr-field--page">
                        <label class="viewer-shell__ocr-label" for="ocr-page">ページ</label>
                        <input
                          id="ocr-page"
                          class="viewer-shell__input"
                          type="number"
                          min="1"
                          [max]="pdf.pageCount() || 1"
                          [ngModel]="selectedOcrPage()"
                          (ngModelChange)="selectedOcrPage.set($event)"
                        />
                      </div>
                    }
                    <button
                      type="button"
                      class="viewer-shell__button viewer-shell__ocr-run"
                      (click)="runOcr()"
                      [disabled]="ocr.isRunning()"
                    >
                      実行
                    </button>
                  </div>
                  <div class="viewer-shell__helper-text viewer-shell__ocr-hint">
                    全ページは処理に時間がかかる場合があります。
                  </div>
                </div>
                @if (ocr.isRunning()) {
                  <div class="viewer-shell__helper-text">OCR 実行中...</div>
                }
                @if (ocr.result(); as result) {
                  <div class="viewer-shell__card">
                    <div class="viewer-shell__card-row">
                      <span class="viewer-shell__tag">{{ ocrResultTag(result) }}</span>
                      <span class="viewer-shell__helper-text">{{ result.durationMs }} ms</span>
                    </div>
                    <div class="viewer-shell__form-row">
                      <button
                        type="button"
                        class="viewer-shell__button viewer-shell__button--ghost"
                        (click)="copyOcrResult()"
                      >
                        クリップボードへコピー
                      </button>
                      <button
                        type="button"
                        class="viewer-shell__button viewer-shell__button--ghost"
                        (click)="exportOcrResult()"
                      >
                        テキストで保存
                      </button>
                    </div>
                    @if (ocrActionMessage()) {
                      <div class="viewer-shell__helper-text">{{ ocrActionMessage() }}</div>
                    }
                    <pre>{{ result.text }}</pre>
                  </div>
                }
              </div>
            </section>
          }
        }

        @if (rightDockTab() === 'compare' && flags.compare) {
          <section class="viewer-shell__panel">
            <div class="viewer-shell__panel-header">
              <h3 class="viewer-shell__panel-title">PDF ファイル比較</h3>
              <button
                type="button"
                class="viewer-shell__button viewer-shell__button--ghost viewer-shell__button--danger"
                (click)="clearCompareMode()"
                [disabled]="compare.isRunning() || !compare.compareTargetSource()"
              >
                比較解除
              </button>
            </div>
            <div class="viewer-shell__panel-body">
              <label class="viewer-shell__file-picker">
                <input
                  class="viewer-shell__file-picker-input"
                  type="file"
                  accept="application/pdf"
                  (change)="onCompareFileChange($event)"
                />
                <span>比較 PDF を選択</span>
              </label>
              @if (compare.compareTargetName()) {
                <div class="viewer-shell__helper-text">対象: {{ compare.compareTargetName() }}</div>
              }
              @if (compare.isRunning()) {
                <div class="viewer-shell__helper-text">比較中...</div>
              }
              @if (compare.result()) {
                <div class="viewer-shell__card">
                  <p>{{ compare.result()?.note }}</p>
                  @if (compare.result()?.changedPages?.length) {
                    <div class="viewer-shell__compare-pages">
                      <span class="viewer-shell__helper-text">変更ページ</span>
                      <div class="viewer-shell__page-chips">
                        @for (page of compare.result()?.changedPages ?? []; track $index) {
                          <button
                            type="button"
                            class="viewer-shell__button viewer-shell__button--ghost viewer-shell__button--small"
                            (click)="jumpToComparePage(page)"
                          >
                            p{{ page }}
                          </button>
                        }
                      </div>
                    </div>
                  } @else {
                    <p class="viewer-shell__helper-text">変更ページ: なし</p>
                  }
                </div>
              }
            </div>
          </section>
        }
      </div>
      <div
        class="viewer-shell__dock-resizer viewer-shell__dock-resizer--right"
        (pointerdown)="startDockResize('right', $event)"
        aria-label="右ドックの幅を調整"
      ></div>
    </aside>
  </div>
</div>
