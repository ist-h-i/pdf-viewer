# 不具合調査報告: 選択範囲ハイライトが反映されない

## 不具合内容

- 操作: PDF 上のテキストをドラッグ選択 → 右クリック → コンテキストメニューの「選択範囲をハイライト」をクリック
- 期待: 選択範囲の背景色が、選択中だけでなくクリック後も指定色でハイライトされ続ける
- 実際: ボタンは活性でクリックできるが、クリック後も PDF 上の背景色が変わらない（ように見える）

## 不具合原因

### 1) `ng2-pdf-viewer` の `.textLayer{opacity:.2}` によりハイライトが視認できない

- `ng2-pdf-viewer` は `:host ::ng-deep .textLayer { opacity: .2; }` を内包しており、PDF のテキストレイヤ全体が 20% の不透明度になります。
- 本アプリの選択ハイライト色は `rgba(..., 0.45)` のため、実効 alpha は `0.45 × 0.2 = 0.09` 程度となり、白背景上ではほぼ白に近い色になって「反映されていない」ように見えます。

### 2) （副次要因）クリックで Selection が消えると、オフセットが無い場合に処理が進まない

- ブラウザ挙動として、コンテキストメニューのボタンをクリックすると選択（Selection）が消えることがあります。
- その場合、クリック時に `window.getSelection()` から範囲を取得できず、`openContextMenu()` で保存した `selectionOffsets` を頼りに範囲復元する必要があります。
- `getSelectionOffsets()` が不要に `textLayouts` の存在を前提にしていたため、条件次第で `selectionOffsets` が `null` になり、クリック後にハイライト適用がスキップされる可能性があります。

## 修正方針

- スタイル: `pdf-viewer` 配下の `.textLayer` の `opacity` を `1` に上書きし、ハイライトの実効 alpha を落とさないようにする（必要なら `!important` で `ng2-pdf-viewer` の指定を上書き）。併せて `::selection` と `.text-highlight` の見た目（角丸等）を調整する。
- ロジック: `getSelectionOffsets()` から不要な `textLayouts` 依存を取り除き、`openContextMenu()` 時点で確実に `selectionOffsets` を保持できるようにする（クリックで Selection が消えても復元できるようにする）。
- 確認: 選択→右クリック→「選択範囲をハイライト」で指定色が視認できること、ズーム/再描画後も保持された範囲が再適用されることを確認する。
