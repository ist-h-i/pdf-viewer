# コメントUI/UX改修（大量コメント対応）方針・設計

作成日: 2025-12-23  
対象: `src/app/pages/viewer-shell/*`（FR-07 コメント）

## 背景
- 業務上、コメント数が 100 件を超えるケースがある。
- 現状の右サイド「コメントカード」は 1 件あたりの表示情報が多く（スレッド全文 + 返信入力）、一覧性・スクロール効率・描画コストが悪い。
- PDF 上のコメント吹き出し（コメントボックス）から返信できず、右パネルに操作が分断されている。

## 要件（今回のスコープ）
1. コメントボックスにコメントを追加する場合、コメントボックスの下段に「アクションエリア（返信用テキストエリア）」を設置し、コメントオブジェクトの下部から返信できること。
2. 画面右側のコメントリストは **ページ単位でセクション化** し、セクション間を **divider** で区切れること。各コメント行は **削除ボタン + タイトル** のみを表示し、**コメント単位でページ番号は表示しない**（ページはセクションヘッダに表示）。

## ゴール
- 右側は「一覧に徹する」: 多数コメントを素早く走査できる。
- 返信（本文追加）は「PDF上のコメント吹き出し」で完結する。
- 既存データ構造（`CommentCard/messages`）を維持し、移行コストを最小化する。

## 非ゴール（今回はやらない）
- コメントの永続化（保存/読込）、共有、権限、監査ログ
- 未読/通知/メンション、解決/ステータス管理
- コメント検索・フィルタ（必要なら次フェーズで追加）

## UI方針
### A. 右サイド: コメント一覧（ページ別セクション + 高密度）
- **ページ毎にエリア（セクション）を設け**、ページヘッダ + divider で区切る。
- ページヘッダに **ページ番号**（必要なら件数）を表示する。
- コメント行の表示項目は **削除 / タイトル** のみ（コメント単位でページ番号は出さない）。
- 行クリックで該当コメントを選択し、該当ページへジャンプする（既存 `focusComment()` を踏襲）。
- コメント本文（スレッド・日時）と返信入力は **右サイドには出さない**。
- タイトルが長い場合は **1行省略（ellipsis）** を基本とし、hover/focus で全文が確認できるようにする（tooltip / title 属性など）。
- 画面が狭い場合は、削除ボタンを **アイコン優先** にし、横幅が詰まってもレイアウトが破綻しないようにする（`min-width: 0` / overflow 制御）。

### B. PDF上: コメント吹き出し（コメントボックス）に返信アクション
- 吹き出し下段に **返信用テキストエリア + 送信ボタン** を配置する。
- 入力は `CommentCard.messages` の末尾に追加する（既存 `addReply()` を踏襲）。
- UI負荷抑制のため、アクションエリアは **選択中コメントのみ表示** を基本とする。
  - 理由: コメント数が多い場合、全コメントで textarea を常時描画すると DOM/レイアウト負荷が増えるため。
  - ただし UX 要望により「常時表示」が必要なら切り替え可能な設計にする。

## 画面イメージ（ワイヤー）
### 右サイド（コメント一覧）
```
[ コメント一覧 ]  123
--------------------------------
 p12 (2)
   [削除]  タイトル...
   [削除]  タイトル...
--------------------------------
 p13 (1)
   [削除]  とても長いタイトルは省略...
 ...
```

### PDF上（コメント吹き出し）
```
[ タイトル................ ] p12 [編集]
--------------------------------------
 msg1...
 msg2...

（選択時のみ）
--------------------------------------
 [ 返信/コメント入力 textarea ...... ]
                     [送信]
```

## 振る舞い設計（ユーザーフロー）
### 1) コメント追加（右クリック → コメントを追加）
1. クリック位置を基準に `AnnotationFacadeService.addComment()` でコメントを作成。
2. 作成したコメントを選択状態にする（`selectedCommentId`）。
3. 吹き出しの返信 textarea にフォーカスして、すぐ入力できる状態にする。

### 2) 返信（吹き出し下段）
- 送信で `addReply(commentId)` を呼び、メッセージを追加 → 入力欄をクリア。
- 送信後はスレッド末尾が見えるようにスクロール（コメント吹き出し内）。
- 送信トリガー:
  - クリック送信（必須）
  - `Ctrl+Enter` 送信（推奨、実装コスト低）

### 3) 一覧からの選択・削除
- 一覧クリック: そのコメントを選択し、該当ページへスクロール（既存挙動を維持）。
- 削除ボタン: コメント削除（既存 `removeComment()` を踏襲）。

## 実装設計（Angular）
### 変更対象（予定）
- `src/app/pages/viewer-shell/viewer-shell.component.html`
  - 右サイドを「ページ別セクション + コメント行（削除/タイトル）」に置き換える（divider で区切り、スレッド/返信UIは右サイドから削除、要件2）。
  - PDF上の `.comment-bubble` 内に返信アクションエリアを追加（要件1）。
- `src/app/pages/viewer-shell/viewer-shell.component.ts`
  - 既存 `replyDrafts`/`setReplyDraft`/`addReply` を吹き出し側UIから利用。
  - 追加: 右サイド表示用にコメントをページ別にグルーピングする view model（並び順/trackBy 含む）。
  - 追加: 「選択コメントの返信 textarea へフォーカス」するための参照管理（テンプレート参照 or QueryList）。
- `src/app/pages/viewer-shell/viewer-shell.component.scss`
  - 右サイドのコメント行/ページヘッダを高密度に（行高・padding/gap を縮小、タイトル ellipsis、狭幅でも崩れない）。
  - 吹き出し下段にアクションエリアを追加（固定配置 + ハンドルとの干渉回避）。

### 既存モデル・状態の扱い
- 既存 `CommentCard` / `CommentMessage` はそのまま。
- 返信下書きは既存の `replyDrafts: Record<commentId, string>` を継続利用。
- 返信欄の placeholder は以下で統一:
  - `messages.length === 0`: 「コメントを追加」
  - `messages.length > 0`: 「返信を記入」

## 受け入れ条件
- PDF上のコメント吹き出しから返信（または最初のコメント）を追加できる。
- 右サイドのコメント一覧が **ページ毎にセクション化** され、セクション間が divider で区切られている。
- 各コメント行は **削除 / タイトル** のみで、コメント単位のページ番号が表示されない。
- コメントが 100 件以上でも、右サイドの一覧で多くの項目が一画面に入り、スクロールで走査できる。
- タイトルが長い場合でもレイアウトが崩れず、省略表示と全文確認（hover/focus）ができる。
- 画面が狭い場合でも操作でき（例: 右パネル幅 280px / ブラウザズーム 125%）、横スクロールやボタン欠けが発生しない。

## 実装タスク（チェックリスト）
- [ ] 右サイドのコメント一覧を **ページ別セクション化** する（divider で区切る）
- [ ] 各コメント行を「削除 / タイトル」だけにする（コメント単位のページ番号を削除）
- [ ] コメント吹き出しに返信アクションエリア（textarea + 送信）を追加（選択時のみ表示をデフォルト）
- [ ] 新規コメント作成直後に返信 textarea へフォーカスする導線を追加
- [ ] `Ctrl+Enter` 送信・送信後クリア・吹き出し内スクロール末尾追従を実装
- [ ] CSS: 一覧の高密度化（行高/padding/gap）、タイトル省略（ellipsis）と全文確認、狭幅時の崩れ防止
- [ ] 手動確認: 100件以上での一覧性、ページセクション区切り、選択→ジャンプ、削除、長いタイトル（100文字/スペースなし含む）、狭幅（右パネル幅 280px）、ブラウザズーム 125%、返信の連続入力

## 次フェーズの候補（必要になったら）
- 右サイドの仮想スクロール（Angular CDK `cdk-virtual-scroll-viewport`）導入
- 一覧の検索/フィルタ（ページ・タイトル）
- ページセクションの折りたたみ（現ページのみ展開など）
- PDF上コメントの表示密度制御（非選択はアンカーのみ/折りたたみ）
